name: Full Integration & Connection Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-connections:
    runs-on: ubuntu-latest

    # Start een tijdelijke RabbitMQ container voor de test
    services:
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      # --- TEST 1: RabbitMQ Connectiviteit ---
      - name: Test RabbitMQ Connection
        env:
          # We gebruiken localhost omdat de service in de runner draait
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
        run: |
          node -e "
          const amqp = require('amqplib');
          async function test() {
            try {
              const conn = await amqp.connect(process.env.RABBITMQ_URL);
              console.log('✅ RabbitMQ verbinding succesvol!');
              await conn.close();
              process.exit(0);
            } catch (err) {
              console.error('❌ RabbitMQ verbinding mislukt:', err.message);
              process.exit(1);
            }
          }
          test();"

      # --- TEST 2: Salesforce API Check ---
      # Let op: dit werkt alleen als je SF_USERNAME, SF_PASSWORD, etc. in GitHub Secrets zet
      - name: Test Salesforce Integration Script
        env:
          SF_LOGIN_URL: ${{ secrets.SF_LOGIN_URL }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_TOKEN: ${{ secrets.SF_TOKEN }}
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_CLIENT_SECRET: ${{ secrets.SF_CLIENT_SECRET }}
        run: |
          if [ -z "$SF_USERNAME" ]; then
            echo "⚠️ Salesforce Secrets niet ingesteld, sla test over."
          else
            # Controleer of de code geen syntax fouten heeft bij het laden van SF modules
            node --check sf-integratie.js
            # Optioneel: voer een kleine verbindingscheck uit als je script dat ondersteunt
            # node sf-integratie.js --check-only
          fi

      # --- TEST 3: Code Linting & Syntax ---
      - name: Validate Core Scripts
        run: |
          node --check server.js
          node --check consumer.js